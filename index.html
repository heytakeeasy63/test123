<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EVA AIR èˆªæƒ…æŒ‡æ®å„€è¡¨æ¿ | å®‰å…¨å­˜å–</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        :root {
            --eva-green: #006241;
            --eva-blue: #1e40af;
            --glass: rgba(255, 255, 255, 0.1);
        }

        body { 
            background: #0f172a; 
            font-family: 'PingFang TC', 'Segoe UI', system-ui, sans-serif;
            color: #f8fafc; height: 100vh; margin: 0; overflow: hidden;
        }

        /* ç£¨ç ‚ç»ç’ƒæ•ˆæœ */
        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* ç™»å…¥é®ç½© */
        #login-overlay {
            position: fixed; inset: 0; z-index: 9999;
            background: radial-gradient(circle at center, #1e293b 0%, #0f172a 100%);
            display: flex; align-items: center; justify-content: center;
        }

        /* é›™æ¬„æ’ç‰ˆæ§åˆ¶ */
        .all-view-container { display: flex; gap: 24px; height: 100%; width: 100%; }
        .view-column { 
            flex: 1; display: flex; flex-direction: column; gap: 16px; 
            overflow-y: auto; padding-right: 8px;
        }
        
        /* æ²è»¸ç¾åŒ– */
        .view-column::-webkit-scrollbar { width: 6px; }
        .view-column::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 10px; }

        /* å¡ç‰‡æ¨£å¼ */
        .card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 20px; padding: 20px;
            transition: all 0.3s ease;
        }
        .card-go { border-left: 4px solid var(--eva-green); }
        .card-back { border-left: 4px solid var(--eva-blue); }
        .card:hover { background: rgba(255, 255, 255, 0.06); transform: translateY(-2px); }

        .btn-select {
            width: 100%; text-align: left; padding: 12px 16px; margin-bottom: 8px;
            border-radius: 12px; background: rgba(255,255,255,0.05);
            font-size: 14px; transition: 0.2s; border: 1px solid transparent;
        }
        .btn-select:hover { background: rgba(255,255,255,0.1); }
        .btn-select.active { 
            background: var(--eva-green); border-color: #10b981; color: white;
            box-shadow: 0 4px 12px rgba(0, 98, 65, 0.3);
        }

        .hidden { display: none !important; }
    </style>
</head>
<body>

<div id="login-overlay">
    <div class="glass-panel p-10 rounded-[2rem] w-full max-w-sm border border-white/10 shadow-2xl text-center">
        <div class="text-5xl mb-6">âœˆï¸</div>
        <h1 class="text-2xl font-black mb-2 tracking-tight text-white">èˆªæƒ…æŒ‡æ®ä¸­å¿ƒ</h1>
        <p class="text-slate-400 text-sm mb-8">è«‹è¼¸å…¥æˆæ¬Šå¸³è™Ÿèˆ‡é‡‘é‘°</p>
        
        <input type="text" id="user-acc" placeholder="å¸³è™Ÿ" 
               class="w-full bg-slate-800/50 border border-slate-700 p-3 rounded-xl mb-3 focus:outline-none focus:border-green-500 transition-all">
        <input type="password" id="user-pwd" placeholder="å¯†ç¢¼" 
               class="w-full bg-slate-800/50 border border-slate-700 p-3 rounded-xl mb-6 focus:outline-none focus:border-green-500 transition-all">
        
        <button onclick="attemptLogin()" 
                class="w-full bg-green-600 hover:bg-green-500 text-white font-bold p-3 rounded-xl shadow-lg transition-all active:scale-95">
            é€²å…¥ç³»çµ±
        </button>
        
        <p id="error-msg" class="text-red-400 text-xs mt-4 hidden font-medium"></p>
    </div>
</div>

<div id="dashboard" class="flex flex-col h-screen hidden">
    <header class="h-16 border-b border-white/5 flex items-center justify-between px-8 bg-slate-900/50">
        <div class="flex items-center gap-3">
            <span class="text-2xl">âœˆï¸</span>
            <span class="font-black text-xl tracking-tighter text-green-500">EVA MONITOR <span class="text-white opacity-40">PRO</span></span>
        </div>
        <div id="clock" class="font-mono text-sm text-slate-400 bg-slate-800 px-4 py-1 rounded-full border border-white/5"></div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        <aside class="w-64 border-r border-white/5 p-6 overflow-y-auto bg-slate-900/20">
            <div class="mb-8">
                <label class="text-[10px] font-bold text-slate-500 uppercase tracking-[0.2em] mb-4 block">æ¨ç´æ©Ÿå ´ Hub</label>
                <div id="airport-list"></div>
            </div>
            <div class="mb-8">
                <label class="text-[10px] font-bold text-slate-500 uppercase tracking-[0.2em] mb-4 block">æŸ¥è©¢æ—¥æœŸ Date</label>
                <div id="date-list"></div>
            </div>
        </aside>

        <main class="flex-1 p-8 flex flex-col overflow-hidden">
            <div class="flex gap-2 mb-8 bg-slate-800/40 p-1 rounded-2xl w-fit border border-white/5">
                <button onclick="setDir('ALL', this)" class="dir-btn px-6 py-2 rounded-xl text-sm font-bold bg-white/10 text-white shadow-sm">å…¨éƒ¨</button>
                <button onclick="setDir('GO', this)" class="dir-btn px-6 py-2 rounded-xl text-sm font-bold text-slate-400 hover:text-white transition-all">ğŸ›« å‡ºå¢ƒ</button>
                <button onclick="setDir('BACK', this)" class="dir-btn px-6 py-2 rounded-xl text-sm font-bold text-slate-400 hover:text-white transition-all">ğŸ›¬ å…¥å¢ƒ</button>
            </div>

            <div id="display-wrapper" class="flex-1 overflow-hidden">
                </div>
        </main>
    </div>
</div>

<script>
    let rawData = [];
    let state = { airport: '', date: '', dir: 'ALL' };

    // æ ¸å¿ƒç™»å…¥èˆ‡è§£å¯†å‡½å¼
    async function attemptLogin() {
        const accInput = document.getElementById('user-acc').value;
        const pwdInput = document.getElementById('user-pwd').value;
        const errorMsg = document.getElementById('error-msg');
        
        console.log("å˜—è©¦ç™»å…¥ä¸­...");

        try {
            const response = await fetch('./encrypted_flights.json');
            if (!response.ok) throw new Error("æ‰¾ä¸åˆ°åŠ å¯†è³‡æ–™æª” (JSON)");

            const encryptedPackage = await response.json();
            
            // ä½¿ç”¨å¯†ç¢¼ä½œç‚ºè§£å¯†é‡‘é‘°
            const key = CryptoJS.SHA256(pwdInput);
            const iv = CryptoJS.enc.Base64.parse(encryptedPackage.iv);
            
            const decrypted = CryptoJS.AES.decrypt(encryptedPackage.payload, key, {
                iv: iv, mode: CryptoJS.mode.CBC, padding: CryptoJS.pad.Pkcs7
            });

            const decryptedStr = decrypted.toString(CryptoJS.enc.Utf8);
            if (!decryptedStr) throw new Error("é‡‘é‘°éŒ¯èª¤ï¼Œç„¡æ³•è§£å¯†");

            const decryptedData = JSON.parse(decryptedStr);
            console.log("è§£å¯†æˆåŠŸï¼");

            if (decryptedData.account !== accInput) {
                throw new Error("å¸³è™Ÿèªè­‰ä¸ç¬¦");
            }

            // æˆåŠŸç™»å…¥
            rawData = decryptedData.data;
            document.getElementById('login-overlay').style.display = 'none';
            document.getElementById('dashboard').classList.remove('hidden');
            
            initApp();

        } catch (e) {
            console.error("Debug Error:", e.message);
            errorMsg.innerText = e.message;
            errorMsg.classList.remove('hidden');
        }
    }

    function initApp() {
        console.log("åˆå§‹åŒ–å„€è¡¨æ¿...");
        
        const airports = [...new Set(rawData.map(d => d.airport))].sort();
        const dates = [...new Set(rawData.map(d => d.date))].sort();

        if (airports.length > 0) {
            renderMenu('airport-list', airports, 'airport');
            state.airport = airports[0];
        }

        if (dates.length > 0) {
            renderMenu('date-list', dates, 'date');
            state.date = dates[0];
        }

        updateUI();
    }

    function renderMenu(id, list, key) {
        const container = document.getElementById(id);
        container.innerHTML = list.map((item, idx) => 
            `<button class="btn-select ${idx === 0 ? 'active' : ''}" 
                     onclick="updateState('${key}', '${item}', this)">${item}</button>`
        ).join('');
    }

    function updateState(key, val, el) {
        state[key] = val;
        el.parentElement.querySelectorAll('.btn-select').forEach(b => b.classList.remove('active'));
        el.classList.add('active');
        updateUI();
    }

    function setDir(dir, el) {
        state.dir = dir;
        document.querySelectorAll('.dir-btn').forEach(b => {
            b.classList.remove('bg-white/10', 'text-white');
            b.classList.add('text-slate-400');
        });
        el.classList.remove('text-slate-400');
        el.classList.add('bg-white/10', 'text-white');
        updateUI();
    }

    function updateUI() {
        const wrapper = document.getElementById('display-wrapper');
        const filtered = rawData.filter(d => d.airport === state.airport && d.date === state.date);

        if (state.dir === 'ALL') {
            const go = filtered.filter(d => d.direction === 'GO');
            const back = filtered.filter(d => d.direction === 'BACK');
            
            wrapper.innerHTML = `
                <div class="all-view-container">
                    <div class="view-column">
                        <div class="text-xs font-black text-green-500 mb-2 px-2 tracking-widest uppercase">ğŸ›« DEPARTURE</div>
                        ${go.length ? go.map(f => renderCard(f)).join('') : '<p class="text-slate-600 p-4">æŸ¥ç„¡èˆªç­</p>'}
                    </div>
                    <div class="view-column">
                        <div class="text-xs font-black text-blue-500 mb-2 px-2 tracking-widest uppercase">ğŸ›¬ ARRIVAL</div>
                        ${back.length ? back.map(f => renderCard(f)).join('') : '<p class="text-slate-600 p-4">æŸ¥ç„¡èˆªç­</p>'}
                    </div>
                </div>`;
        } else {
            const single = filtered.filter(d => d.direction === state.dir);
            wrapper.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 overflow-y-auto h-full pr-4">
                    ${single.map(f => renderCard(f)).join('')}
                </div>`;
        }
    }

    function renderCard(f) {
        const isGo = f.direction === 'GO';
        const bizColor = parseInt(f.business) > 0 ? 'text-green-400' : 'text-red-500';
        
        return `
            <div class="card ${isGo ? 'card-go' : 'card-back'}">
                <div class="flex justify-between items-start mb-6">
                    <div>
                        <h3 class="text-2xl font-black tracking-tighter text-white">${f.flight_no}</h3>
                        <p class="text-[10px] text-slate-500 font-bold uppercase mt-1">${f.route}</p>
                    </div>
                    <div class="bg-black/30 px-3 py-1 rounded-lg border border-white/5">
                        <span class="text-[10px] font-mono text-slate-400">${f.airport}</span>
                    </div>
                </div>

                <div class="flex items-center gap-4 bg-slate-900/40 p-4 rounded-xl mb-6">
                    <div class="flex-1 text-center">
                        <p class="text-[9px] text-slate-500 uppercase font-bold">Departure</p>
                        <p class="text-lg font-black">${f.dep_time || '--:--'}</p>
                    </div>
                    <div class="text-slate-700">â†’</div>
                    <div class="flex-1 text-center">
                        <p class="text-[9px] text-slate-500 uppercase font-bold">Arrival</p>
                        <p class="text-lg font-black">${f.arr_time || '--:--'}</p>
                    </div>
                </div>

                <div class="grid grid-cols-3 gap-3">
                    <div class="bg-white/5 rounded-xl p-2 text-center">
                        <p class="text-[8px] text-slate-500 font-bold uppercase mb-1">C Class</p>
                        <p class="text-xl font-black ${bizColor}">${f.business}</p>
                    </div>
                    <div class="bg-white/5 rounded-xl p-2 text-center">
                        <p class="text-[8px] text-slate-500 font-bold uppercase mb-1">Y Class</p>
                        <p class="text-xl font-black text-white">${f.economy}</p>
                    </div>
                    <div class="bg-white/5 rounded-xl p-2 text-center border border-white/10">
                        <p class="text-[8px] text-slate-500 font-bold uppercase mb-1">Total Pax</p>
                        <p class="text-xl font-black text-yellow-500">${f.pax}</p>
                    </div>
                </div>
            </div>`;
    }

    // æ›´æ–°æ™‚é˜
    setInterval(() => {
        document.getElementById('clock').innerText = new Date().toLocaleString('zh-TW', {
            hour12: false, year: 'numeric', month: '2-digit', day: '2-digit', 
            hour: '2-digit', minute: '2-digit', second: '2-digit'
        });
    }, 1000);
</script>
</body>
</html>
