<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EVA AIR èˆªæƒ…å„€è¡¨æ¿ | Mobile Optimized</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { --eva-green: #006241; --eva-blue: #1e40af; }
        body { background: #0f172a; color: #f8fafc; font-family: system-ui, sans-serif; height: 100vh; margin: 0; overflow: hidden; }

        /* éŸ¿æ‡‰å¼ä½ˆå±€æ ¸å¿ƒ */
        .main-layout { display: flex; flex-direction: column; height: 100vh; }
        @media (min-width: 768px) { .main-layout { flex-direction: row; } }

        /* å´é‚Šæ¬„ï¼šæ‰‹æ©Ÿç‰ˆæ”¹ç‚ºé ‚éƒ¨æ©«å‘æ²å‹• */
        .sidebar { 
            width: 100%; padding: 15px; background: rgba(30, 41, 59, 0.5); 
            border-bottom: 1px solid rgba(255,255,255,0.1); overflow-x: auto; flex-shrink: 0;
        }
        @media (min-width: 768px) { 
            .sidebar { width: 260px; height: 100%; border-bottom: none; border-right: 1px solid rgba(255,255,255,0.1); overflow-y: auto; } 
        }

        /* é›™æ¬„åˆ‡æ›ï¼šæ‰‹æ©Ÿç‰ˆä¸Šä¸‹ï¼Œé›»è…¦ç‰ˆå·¦å³ */
        .all-view-container { 
            display: flex; flex-direction: column; gap: 20px; height: 100%; width: 100%; 
        }
        @media (min-width: 1024px) { 
            .all-view-container { flex-direction: row; gap: 24px; } 
        }

        .view-column { 
            flex: 1; display: flex; flex-direction: column; gap: 12px; 
            overflow-y: auto; padding-bottom: 20px;
        }

        /* å¡ç‰‡ç¸®å°ä¸€é»ä»¥é©æ‡‰æ‰‹æ©Ÿ */
        .card {
            background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 16px; padding: 16px; border-left: 4px solid #ccc;
        }
        .card-go { border-left-color: var(--eva-green); }
        .card-back { border-left-color: var(--eva-blue); }

        .btn-select { 
            padding: 8px 12px; border-radius: 8px; background: rgba(255,255,255,0.05);
            font-size: 13px; white-space: nowrap; transition: 0.2s;
        }
        .btn-select.active { background: var(--eva-green); color: white; }

        .hidden { display: none !important; }
    </style>
</head>
<body>

<div id="login-overlay" class="fixed inset-0 z-[9999] bg-slate-950 flex items-center justify-center p-6">
    <div class="bg-slate-900 p-8 rounded-3xl w-full max-w-sm border border-white/10 text-center">
        <h1 class="text-xl font-bold mb-6">èˆªæƒ…æŒ‡æ®ä¸­å¿ƒ</h1>
        <input type="text" id="user-acc" placeholder="å¸³è™Ÿ" class="w-full bg-slate-800 border border-slate-700 p-3 rounded-xl mb-3 text-white">
        <input type="password" id="user-pwd" placeholder="å¯†ç¢¼" class="w-full bg-slate-800 border border-slate-700 p-3 rounded-xl mb-6 text-white">
        <button onclick="attemptLogin()" class="w-full bg-green-600 p-3 rounded-xl font-bold">ç™»å…¥</button>
        <p id="error-msg" class="text-red-400 text-xs mt-4 hidden"></p>
    </div>
</div>

<div id="dashboard" class="main-layout hidden">
    <header class="hidden md:flex h-14 border-b border-white/5 items-center justify-between px-6 bg-slate-900/80">
        <span class="font-black text-green-500">EVA MONITOR PRO</span>
        <div id="clock" class="text-xs font-mono opacity-50"></div>
    </header>

    <div class="flex flex-col md:flex-row flex-1 overflow-hidden">
        <aside class="sidebar">
            <div class="flex md:flex-col gap-4">
                <div class="flex-shrink-0">
                    <p class="text-[9px] font-bold text-slate-500 uppercase mb-2">Airport</p>
                    <div id="airport-list" class="flex md:flex-col gap-2"></div>
                </div>
                <div class="flex-shrink-0">
                    <p class="text-[9px] font-bold text-slate-500 uppercase mb-2">Date</p>
                    <div id="date-list" class="flex md:flex-col gap-2"></div>
                </div>
            </div>
        </aside>

        <main class="flex-1 p-4 md:p-8 flex flex-col overflow-hidden">
            <div class="flex gap-2 mb-4 bg-slate-800/40 p-1 rounded-xl w-fit">
                <button onclick="setDir('ALL', this)" class="dir-btn px-4 py-1.5 rounded-lg text-xs font-bold bg-white/10">å…¨éƒ¨</button>
                <button onclick="setDir('GO', this)" class="dir-btn px-4 py-1.5 rounded-lg text-xs font-bold text-slate-400">ğŸ›« å‡ºå¢ƒ</button>
                <button onclick="setDir('BACK', this)" class="dir-btn px-4 py-1.5 rounded-lg text-xs font-bold text-slate-400">ğŸ›¬ å…¥å¢ƒ</button>
            </div>

            <div id="display-wrapper" class="flex-1 overflow-y-auto"></div>
        </main>
    </div>
</div>

<script>
    let rawData = [];
    let state = { airport: '', date: '', dir: 'ALL' };

    async function attemptLogin() {
        const acc = document.getElementById('user-acc').value;
        const pwd = document.getElementById('user-pwd').value;
        try {
            const res = await fetch('./encrypted_flights.json');
            const pkg = await res.json();
            const key = CryptoJS.SHA256(pwd);
            const iv = CryptoJS.enc.Base64.parse(pkg.iv);
            const dec = CryptoJS.AES.decrypt(pkg.payload, key, { iv: iv, mode: CryptoJS.mode.CBC, padding: CryptoJS.pad.Pkcs7 });
            const data = JSON.parse(dec.toString(CryptoJS.enc.Utf8));
            if (data.account !== acc) throw new Error("å¸³è™ŸéŒ¯èª¤");
            
            rawData = data.data;
            document.getElementById('login-overlay').style.display = 'none';
            document.getElementById('dashboard').classList.remove('hidden');
            initApp();
        } catch (e) {
            document.getElementById('error-msg').innerText = "é©—è­‰å¤±æ•—";
            document.getElementById('error-msg').classList.remove('hidden');
        }
    }

    function initApp() {
        const airports = [...new Set(rawData.map(d => d.airport))].sort();
        const dates = [...new Set(rawData.map(d => d.date))].sort();
        renderMenu('airport-list', airports, 'airport');
        renderMenu('date-list', dates, 'date');
        state.airport = airports[0];
        state.date = dates[0];
        updateUI();
    }

    function renderMenu(id, list, key) {
        document.getElementById(id).innerHTML = list.map((item, idx) => 
            `<button class="btn-select ${idx === 0 ? 'active' : ''}" onclick="updateState('${key}', '${item}', this)">${item}</button>`
        ).join('');
    }

    function updateState(key, val, el) {
        state[key] = val;
        el.parentElement.querySelectorAll('.btn-select').forEach(b => b.classList.remove('active'));
        el.classList.add('active');
        updateUI();
    }

    function setDir(dir, el) {
        state.dir = dir;
        document.querySelectorAll('.dir-btn').forEach(b => { b.classList.remove('bg-white/10'); b.classList.add('text-slate-400'); });
        el.classList.add('bg-white/10'); el.classList.remove('text-slate-400');
        updateUI();
    }

    function updateUI() {
        const wrapper = document.getElementById('display-wrapper');
        const filtered = rawData.filter(d => d.airport === state.airport && d.date === state.date);

        if (state.dir === 'ALL') {
            const go = filtered.filter(d => d.direction === 'GO');
            const back = filtered.filter(d => d.direction === 'BACK');
            wrapper.innerHTML = `
                <div class="all-view-container">
                    <div class="view-column">
                        <div class="text-[10px] font-bold text-green-500 mb-2 px-1 uppercase tracking-widest">ğŸ›« å‡ºå¢ƒ DEPARTURE</div>
                        ${go.map(f => renderCard(f)).join('')}
                    </div>
                    <div class="view-column">
                        <div class="text-[10px] font-bold text-blue-500 mb-2 px-1 uppercase tracking-widest">ğŸ›¬ å…¥å¢ƒ ARRIVAL</div>
                        ${back.map(f => renderCard(f)).join('')}
                    </div>
                </div>`;
        } else {
            const single = filtered.filter(d => d.direction === state.dir);
            wrapper.innerHTML = `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">${single.map(f => renderCard(f)).join('')}</div>`;
        }
    }

    function renderCard(f) {
        const isGo = f.direction === 'GO';
        return `
            <div class="card ${isGo ? 'card-go' : 'card-back'}">
                <div class="flex justify-between items-center mb-3">
                    <span class="text-lg font-black tracking-tighter">${f.flight_no}</span>
                    <span class="text-[10px] font-mono opacity-50">${f.route}</span>
                </div>
                <div class="flex justify-between bg-black/20 p-2 rounded-lg mb-3 text-center">
                    <div class="flex-1"><p class="text-[8px] opacity-40">DEP</p><p class="font-bold text-sm">${f.dep_time || '--:--'}</p></div>
                    <div class="flex-1 border-l border-white/5"><p class="text-[8px] opacity-40">ARR</p><p class="font-bold text-sm">${f.arr_time || '--:--'}</p></div>
                </div>
                <div class="grid grid-cols-3 gap-2">
                    <div class="bg-white/5 p-1.5 rounded-lg text-center">
                        <p class="text-[8px] opacity-40">C</p><p class="font-bold ${parseInt(f.business) > 0 ? 'text-green-400' : 'text-red-500'}">${f.business}</p>
                    </div>
                    <div class="bg-white/5 p-1.5 rounded-lg text-center">
                        <p class="text-[8px] opacity-40">Y</p><p class="font-bold">${f.economy}</p>
                    </div>
                    <div class="bg-white/5 p-1.5 rounded-lg text-center border border-white/10">
                        <p class="text-[8px] opacity-40">PAX</p><p class="font-bold text-yellow-500">${f.pax}</p>
                    </div>
                </div>
            </div>`;
    }
</script>
</body>
</html>
