<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>èˆªç­æ©Ÿä½ç†±åŠ›ç›£æ§çŸ©é™£</title>
    <link href="https://unpkg.com/tabulator-tables@5.5.0/dist/css/tabulator_modern.min.css" rel="stylesheet">
    <script src="https://unpkg.com/tabulator-tables@5.5.0/dist/js/tabulator.min.js"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #f8f9fa; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        #matrix-table { background: white; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .cell-green { background-color: #d1fae5 !important; color: #065f46; font-weight: bold; }
        .cell-red { background-color: #fee2e2 !important; color: #991b1b; }
        .cell-gray { background-color: #f3f4f6 !important; color: #9ca3af; }
    </style>
</head>
<body>

<div class="header">
    <h1>ğŸ“Š é•·æ¦®èˆªç­ 14 å¤©æ©Ÿä½ç†±åŠ›åœ–</h1>
    <div id="last-update">æœ€å¾Œæ›´æ–°ï¼šè¼‰å…¥ä¸­...</div>
</div>

<div id="matrix-table"></div>

<script>
    fetch('./weekly_flights.json')
        .then(res => res.json())
        .then(data => {
            // 1. å–å¾—æ‰€æœ‰ä¸é‡è¤‡çš„æ—¥æœŸä¸¦æ’åº (åšç‚ºæ©«è»¸)
            const dates = [...new Set(data.map(item => item.date))].sort();
            
            // 2. è½‰æ›è³‡æ–™çµæ§‹ï¼šä»¥èˆªç­ç‚º Keyï¼Œæ—¥æœŸç‚ºå±¬æ€§
            const pivotData = {};
            data.forEach(item => {
                if (!pivotData[item.flight_no]) {
                    pivotData[item.flight_no] = { 
                        flight: item.flight_no, 
                        route: item.route,
                        country: item.country,
                        direction: item.direction
                    };
                }
                // å°‡è©²æ—¥æœŸçš„æ©Ÿä½å­˜å…¥
                pivotData[item.flight_no][item.date] = item.business;
            });

            const tableData = Object.values(pivotData);

            // 3. å‹•æ…‹ç”¢ç”Ÿæ¬„ä½è¨­å®š
            const columns = [
                {title:"èˆªç­", field:"flight", width:100, frozen:true},
                {title:"èˆªç·š", field:"route", width:150},
            ];

            // ç‚ºæ¯ä¸€å¤©ç”¢ç”Ÿä¸€å€‹æ¬„ä½
            dates.forEach(d => {
                columns.push({
                    title: d.substring(5), // åªé¡¯ç¤º MM-DD
                    field: d,
                    width: 80,
                    hozAlign: "center",
                    formatter: function(cell) {
                        const val = cell.getValue();
                        if (val === "0" || val === "0-") {
                            cell.getElement().classList.add("cell-red");
                            return "ğŸˆµ";
                        } else if (val === undefined) {
                            cell.getElement().classList.add("cell-gray");
                            return "-";
                        } else {
                            cell.getElement().classList.add("cell-green");
                            return val;
                        }
                    }
                });
            });

            // 4. æ¸²æŸ“è¡¨æ ¼
            new Tabulator("#matrix-table", {
                data: tableData,
                columns: columns,
                layout: "fitColumns",
                movableColumns: true
            });
            
            document.getElementById('last-update').innerText = "æœ€å¾Œæ›´æ–°ï¼š" + new Date().toLocaleString();
        });
</script>
</body>
</html>
