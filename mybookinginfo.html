<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>é•·æ¦®èˆªç­æ©Ÿä½çµæ§‹åŒ–çœ‹æ¿</title>
    <link href="https://unpkg.com/tabulator-tables@5.5.0/dist/css/tabulator_modern.min.css" rel="stylesheet">
    <script src="https://unpkg.com/tabulator-tables@5.5.0/dist/js/tabulator.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: #f0f2f5; margin: 0; padding: 20px; }
        .nav-container { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .tab-group { margin-bottom: 10px; display: flex; align-items: center; gap: 10px; }
        .tab-label { font-weight: bold; min-width: 60px; color: #555; }
        button { padding: 8px 16px; border: 1px solid #ddd; background: white; cursor: pointer; border-radius: 6px; }
        button.active { background: #00a650; color: white; border-color: #00a650; }
        
        /* çŸ©é™£æ ¼å­å…§çš„å…§å®¹æ¨£å¼ */
        .seat-info { line-height: 1.2; font-size: 11px; padding: 4px 0; }
        .seat-count { font-weight: bold; font-size: 14px; display: block; }
        .pax-count { color: #666; font-size: 10px; }
        .time-label { color: #005a87; font-weight: bold; display: block; margin-top: 2px; }

        .cell-green { background-color: #e3f9e5 !important; }
        .cell-red { background-color: #fee2e2 !important; }
        .cell-empty { background-color: #f9fafb !important; color: #ccc; }
    </style>
</head>
<body>

<div class="nav-container">
    <div class="tab-group">
        <span class="tab-label">ğŸŒ åœ‹å®¶ï¼š</span>
        <div id="country-tabs"></div>
    </div>
    <div class="tab-group">
        <span class="tab-label">ğŸ“ æ©Ÿå ´ï¼š</span>
        <div id="airport-tabs"></div>
    </div>
</div>

<div id="matrix-table"></div>

<script>
    let rawData = [];
    let currentCountry = "";
    let currentAirport = "";

    fetch('./weekly_flights.json').then(res => res.json()).then(data => {
        rawData = data;
        initNavigation();
    });

    function initNavigation() {
        const countries = [...new Set(rawData.map(d => d.country))];
        const countryContainer = document.getElementById('country-tabs');
        
        countries.forEach((c, idx) => {
            const btn = document.createElement('button');
            btn.innerText = c;
            btn.onclick = () => {
                currentCountry = c;
                updateAirportTabs();
                setActive(countryContainer, btn);
            };
            countryContainer.appendChild(btn);
            if(idx === 0) btn.click();
        });
    }

    function updateAirportTabs() {
        const airports = [...new Set(rawData.filter(d => d.country === currentCountry).map(d => d.airport))];
        const airportContainer = document.getElementById('airport-tabs');
        airportContainer.innerHTML = "";

        airports.forEach((a, idx) => {
            const btn = document.createElement('button');
            btn.innerText = a;
            btn.onclick = () => {
                currentAirport = a;
                renderMatrix();
                setActive(airportContainer, btn);
            };
            airportContainer.appendChild(btn);
            if(idx === 0) btn.click();
        });
    }

    function renderMatrix() {
        const filtered = rawData.filter(d => d.country === currentCountry && d.airport === currentAirport);
        const dates = [...new Set(rawData.map(d => d.date))].sort();
        
        // åˆ†çµ„ï¼šå‡ºå¢ƒ GO èˆ‡ å…¥å¢ƒ BACK
        const pivotData = {};
        filtered.forEach(f => {
            const key = f.flight_no;
            if(!pivotData[key]) {
                pivotData[key] = { 
                    flight: f.flight_no, 
                    dir: f.direction,
                    route: f.route,
                    time: f.time // å‡è¨­ JSON è£¡æœ‰ time æ¬„ä½
                };
            }
            pivotData[key][f.date] = f;
        });

        const columns = [
            {title:"èˆªç­", field:"flight", width:80, frozen:true},
            {title:"æ–¹å‘", field:"dir", width:70, formatter: v => v.getValue() === "GO" ? "ğŸ›« å‡ºå¢ƒ" : "ğŸ›¬ å…¥å¢ƒ"},
            {title:"è·¯ç·š/æ™‚é–“", field:"route", width:140, formatter: cell => {
                const d = cell.getData();
                return `<div style="font-size:11px">${d.route}</div>`;
            }}
        ];

        dates.forEach(d => {
            columns.push({
                title: d.substring(5),
                field: d,
                width: 90,
                hozAlign: "center",
                formatter: function(cell) {
                    const val = cell.getValue();
                    if (!val) return "<span class='cell-empty'>-</span>";
                    
                    const isFull = val.business === "0" || val.business === "0-";
                    cell.getElement().classList.add(isFull ? "cell-red" : "cell-green");

                    // é€™è£¡çµ„åˆ C/Y/Pax èˆ‡ æ™‚é–“
                    return `
                        <div class="seat-info">
                            <span class="seat-count">C${val.business} Y${val.economy}</span>
                            <span class="pax-count">ğŸ‘¤ Pax: ${val.pax}</span>
                        </div>
                    `;
                }
            });
        });

        new Tabulator("#matrix-table", {
            data: Object.values(pivotData),
            columns: columns,
            layout: "fitDataFill",
            height: "600px"
        });
    }

    function setActive(container, activeBtn) {
        container.querySelectorAll('button').forEach(b => b.classList.remove('active'));
        activeBtn.classList.add('active');
    }
</script>
</body>
</html>
